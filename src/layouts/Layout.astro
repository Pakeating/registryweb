---
import Navbar from '../components/Navbar.astro';
import FeedbackIcon from '../components/FeedbackIcon.astro'; // Importamos el nuevo componente

// Original manifest with relative paths
const manifest = {
  name: 'Registro de Comidas',
  short_name: 'Comidas',
  description: 'Una app para registrar comidas y enviarlas a Notion.',
  start_url: '/',
  display: 'standalone',
  scope: '/',
  theme_color: '#F5F5F4',
  background_color: '#F5F5F4',
  icons: [
    {
      src: '/icons/icon-192x192.svg',
      sizes: '192x192',
      type: 'image/svg+xml'
    },
    {
      src: '/icons/icon-512x512.svg',
      sizes: '512x512',
      type: 'image/svg+xml',
      purpose: 'any maskable'
    }
  ]
};

// Create a new manifest with absolute URLs for all relevant properties.
const siteUrl = Astro.url.origin;
const manifestWithAbsoluteUrls = {
  ...manifest,
  start_url: `${siteUrl}${manifest.start_url}`,
  scope: `${siteUrl}${manifest.scope}`,
  icons: manifest.icons.map(icon => ({
    ...icon,
    src: `${siteUrl}${icon.src}`
  }))
};

// Encode the manifest, replacing '#' with its URL-safe equivalent '%23'
const encodedManifest = JSON.stringify(manifestWithAbsoluteUrls).replace(/#/g, '%23');
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>RegistryWeb</title>
    <link rel="manifest" href={`data:application/manifest+json,${encodedManifest}`} />
    <meta name="theme-color" content={manifest.theme_color} />
    <style is:global>
        @import '../styles/global.css';
    </style>
	</head>
	<body>
    <Navbar />
		<slot />
    <FeedbackIcon client:load />
    <script>
        import { registerSW } from 'virtual:pwa-register';
        import { auth } from '../firebase/config.ts';
        import { onAuthStateChanged } from "firebase/auth";

        registerSW({
            onOfflineReady() {
                console.log("La aplicación está lista para funcionar sin conexión.");
            },
        });

        // --- AUTHENTICATION GATE ---
        // Se ejecuta en el cliente para todas las páginas que usen este Layout.
        // Si el usuario no está en la página de login y no está autenticado,
        // se le redirige al login.
        if (window.location.pathname !== '/') {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    console.log('Usuario no autenticado. Redirigiendo a /');
                    window.location.href = '/';
                }
            });
        }
        
        // Health check to "wake up" the serverless backend on page load.
        (async () => {
            try {
                const response = await fetch('/api/proxy');
                if (!response.ok) {
                    console.warn(`Backend health check failed with status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error during backend health check:', error);
            }
        })();
    </script>
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
        background-color: #F5F5F4; /* stone-100 */
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
	}
</style>
